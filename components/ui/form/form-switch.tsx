import * as React from 'react';
import { View } from 'react-native';
import { Switch } from '../switch';
import { FormItem } from './form';
import { FormLabel } from './form-label';
import { FormDescription } from './form-description';
import { FormMessage } from './form-message';
import { useFormField } from './form';
import type { Override } from './types';
import { Noop } from 'react-hook-form';

interface FormFieldFieldProps<T> {
  name: string;
  onBlur: Noop;
  onChange: (val: T) => void;
  value: T;
  disabled?: boolean;
}

type FormItemProps<T extends React.ElementType<any>, U> = Override<
  React.ComponentPropsWithoutRef<T>,
  FormFieldFieldProps<U>
> & {
  label?: string;
  description?: string;
};

const FormSwitch = React.forwardRef<
  React.ComponentRef<typeof Switch>,
  Omit<FormItemProps<typeof Switch, boolean>, 'checked' | 'onCheckedChange'>
>(({ label, description, value, onChange, ...props }, ref) => {
  const switchRef = React.useRef<React.ComponentRef<typeof Switch>>(null);
  const { error, formItemNativeID, formDescriptionNativeID, formMessageNativeID } = useFormField();

  React.useImperativeHandle(ref, () => {
    if (!switchRef.current) {
      return {} as React.ComponentRef<typeof Switch>;
    }
    return switchRef.current;
  }, [switchRef.current]);

  function handleOnLabelPress() {
    onChange?.(!value);
  }

  return (
    <FormItem className="px-1">
      <View className="flex-row justify-between gap-3">
        <View>
          {!!label && (
            <FormLabel className="pb-0" nativeID={formItemNativeID} onPress={handleOnLabelPress}>
              {label}
            </FormLabel>
          )}
          {!!description && <FormDescription>{description}</FormDescription>}
        </View>
        <Switch
          // @ts-ignore
          ref={switchRef}
          aria-labelledby={formItemNativeID}
          aria-describedby={
            !error
              ? `${formDescriptionNativeID}`
              : `${formDescriptionNativeID} ${formMessageNativeID}`
          }
          aria-invalid={!!error}
          onCheckedChange={onChange}
          checked={value}
          {...props}
        />
      </View>
      <FormMessage />
    </FormItem>
  );
});

FormSwitch.displayName = 'FormSwitch';

export { FormSwitch };
